---
title: "4_CFA"
author: "Nick Kathios"
date: '2023-03-22'
output: html_document
---

```{r}
library(tidyverse)
source("../reverseCode.R")
library(psych)
library(corrplot)
```

#read in data
```{r}
first <- read.csv(file='../../data/pleasing-displeasing_followup/scored_data.csv') 
second <- read.csv(file='../../data/SLfollowupscored.csv')

#keep <- setdiff(second$ID,first$Q158)

#second <- second[second$ID %in% keep, ] 

MH <- second %>%
  dplyr::select("M.H_child1_1":"M.H_child20_1")

#MH <- MH[complete.cases(MH),]

cols_reverse <- c("M.H_child6_1","M.H_child7_1","M.H_child11_1","M.H_child12_1","M.H_child18_1","M.H_child19_1","M.H_child20_1")
MH[cols_reverse] <- lapply(MH[cols_reverse], reverseCode, min=1, max=7)
```

#CFA
```{r}
model <- 'G =~ M.H_child1_1 + M.H_child2_1 + M.H_child3_1 + M.H_child4_1 + M.H_child9_1 + M.H_child10_1 + M.H_child11_1  + M.H_child13_1 + M.H_child18_1 + M.H_child19_1 + M.H_child20_1 + M.H_child14_1 + M.H_child15_1 + M.H_child16_1 + M.H_child17_1 + M.H_child5_1 + M.H_child6_1 + M.H_child7_1 + M.H_child8_1 + M.H_child12_1
  caregiverbeliefs   =~ M.H_child1_1 + M.H_child2_1 + M.H_child3_1 + M.H_child4_1 
  caregiversinging =~ M.H_child9_1 + M.H_child10_1 + M.H_child11_1 + M.H_child13_1 
  childhoodattitude   =~ M.H_child18_1 + M.H_child19_1 + M.H_child20_1 
  socialcontexts  =~ M.H_child14_1 + M.H_child15_1 + M.H_child16_1 + M.H_child17_1 
  musicmaking =~ M.H_child5_1 + M.H_child6_1 + M.H_child7_1 + M.H_child8_1 + M.H_child12_1

## restrictions --> make sure factors are uncorrelated
G ~~ 0*caregiverbeliefs
G ~~ 0*caregiversinging
G ~~ 0*childhoodattitude
G ~~ 0*socialcontexts
G ~~ 0*musicmaking

caregiverbeliefs ~~ 0*caregiversinging
caregiverbeliefs ~~ 0*childhoodattitude
caregiverbeliefs ~~ 0*socialcontexts
caregiverbeliefs ~~ 0*musicmaking

caregiversinging ~~ 0*childhoodattitude
caregiversinging ~~ 0*socialcontexts
caregiversinging ~~ 0*musicmaking

childhoodattitude ~~ 0*socialcontexts
childhoodattitude ~~ 0*musicmaking

socialcontexts ~~ 0*musicmaking

#residual variances --> setting to 1
    G ~~ 1*G
    caregiverbeliefs ~~ 1*caregiverbeliefs
    caregiversinging ~~ 1*caregiversinging
    childhoodattitude ~~ 1*childhoodattitude
    socialcontexts ~~ 1*socialcontexts
    musicmaking ~~ 1*musicmaking'

fitG <- lavaan::cfa(model, data = MH)
lavaan::summary(fitG, fit.measures = T)
inspect(fitG,what="std")$lambda

semPlot::semPaths(fitG)
```

```{r}
#scoring
cols_caregiverbeliefs <- c("M.H_child1_1","M.H_child2_1","M.H_child3_1","M.H_child4_1")
cols_caregiversinging <- c("M.H_child9_1","M.H_child10_1","M.H_child11_1","M.H_child13_1")
cols_childhoodattitude <- c("M.H_child18_1","M.H_child19_1","M.H_child20_1")
cols_socialcontexts <- c("M.H_child14_1","M.H_child15_1","M.H_child16_1","M.H_child17_1")
cols_musicmaking <- c("M.H_child5_1","M.H_child6_1","M.H_child7_1","M.H_child8_1", "M.H_child12_1")


#scoring
second$MH_total <- apply(MH,1, sum) # total BMRQ scores
second$MH_caregiverbeliefs <- apply(MH[cols_caregiverbeliefs], 1,sum)
second$MH_caregiversinging <- apply(MH[cols_caregiversinging],1, sum)
second$MH_childhoodattitude <-apply(MH[cols_childhoodattitude],1, sum)
second$MH_socialcontexts <- apply(MH[cols_socialcontexts],1, sum)
second$MH_musicmaking <- apply(MH[cols_musicmaking],1, sum)


#validity tests
variables = dplyr::select(second, 
                          MH_total,MH_caregiverbeliefs,
                          MH_caregiversinging, MH_childhoodattitude, MH_musicmaking, MH_socialcontexts,
                          MET_melodicscore, MET_rhythmicscore, SRQ_adol_total,
                          SRQ_current_total)
output = corr.test(variables)

corr_matrix = output$r
p_matrix <- output$p

colnames(corr_matrix) <- c("1","2", "3",
                           "4", "5", 
                           "6","7", "8", 
                           "9", "10")
rownames(corr_matrix) <- c("1","2", "3",
                           "4", "5", 
                           "6","7", "8", 
                           "9", "10")

pdf(file = "../../figures/statistical_learningfollowup/CFA_new.pdf",width = 13, height=13)

corrplot(corr_matrix, p.mat = p_matrix, insig = "label_sig",
         sig.level = c(0.001,0.01,0.05), pch.cex=0.9, pch.col = "black", tl.col = "black", type="lower",tl.srt =45, 
         col=colorRampPalette(c("darkblue","white","red"))(100),cl.lim=c(0,1), diag = FALSE,tl.cex = 3, cl.cex = 2)

dev.off()

m1 <- lm(CD.RISC_total ~ MH_caregiverbeliefs + MH_caregiversinging + MH_childhoodattitude + MH_musicmaking + MH_socialcontexts, data=second)
summary(m1)
```


#test-retest correlations
```{r}
retest <- merge(second, first,by.x="ID",by.y="PROLIFIC_PID")
mean(retest$What.is.your.age., na.rm = TRUE)
cor.test(retest$MH_total.x, retest$MH_total.y)
```


```{r}
second$HUMS_adult_healthy
sd(second$What.is.your.age., na.rm=TRUE)

model <- lm(MET_melodicscore ~ MH_caregiverbeliefs + MH_caregiversinging + MH_childhoodattitude + MH_musicmaking + MH_socialcontexts, data=second)

summary(model)

cor.test(second$MH_caregiverbeliefs, second$QUIC_child_safetyandsecurity)
```

